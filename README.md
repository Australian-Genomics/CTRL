# Australian Genomics Health Alliance CTRL Project

The [AGHA(Australian Genomics Health
Alliance)](https://www.australiangenomics.org.au/introducing-ctrl-a-new-online-research-consent-and-engagement-platform/)
Dynamic Consent project is building a web based platform that will manage
consent for genomic testing, and allow participants to manage their preferences
around how and where their test results are received and shared.

CTRL is distributed under the terms of the [MIT licence](LICENSE).

## Table of Contents

- [Installation](#installation)
  - [Getting Started - via Docker (recommended)](#gettingstarteddocker)
  - [Getting Started - Standard](#gettingstartedstandard)
  - [Creating an Admin account](#creatingadminaccount)
- [Guides](#guides)
  - [Strategies for Multi-Language Support](#strategiesfori18n)
  - [Two Factor Authentication integration](#2faintegration)
  - [Password security and user validation](#passwordsecurityanduservalidation)
  - [Integration of a Content Management System](#integrationofcms)
  - [Resetting your environment](#resetenv)
- [Testing](#testing)
  - [Known Issues](#testingknownissues)
- [Deployment](#deployment)
  - [Installing Heroku](#installingheroku)
  - [Deploying to Heroku](#deployingtoheroku)
- [Environment Variables](#environment-variables)

## <a id="installation"></a> Installation

Starting from release `v1.0.0` CTRL follows the [Gitflow model](https://nvie.com/posts/a-successful-git-branching-model/).
This means active development happens on the `devel` branch, while the `main` branch only contains
official releases, tagged with their version number. Depending on your needs please check out the
appropriate branch and tag.

### <a id="gettingstarteddocker"></a> Getting Started - via Make and Docker (recommended)

There are two ways to get started, via Docker or the standard way. We recommend using Docker to minimise operating system installation issues. To install via Docker, first make sure that [Docker](https://www.docker.com/) is installed on your machine, then follow these steps.

There is a [makefile](https://opensource.com/article/18/8/what-how-makefile) (requires Gnu Make to be installed), which makes it easier to get a development environment up and running.

#### Decode or create `config/credentials.yml`

If you have been given the `master.key` file, move it to `config/master.key`.
This decodes the `config/credentials.yml.enc` file which should already be
present in this repo. Otherwise, you can create your own `config/master.key` and
`config/credentials.yml.env` files by deleting `config/credentials.yml.enc` then
running:

```shell
# Generate new keys and salts. Prints to std out.
make generate-keys

# Open config/credentials file using:
make edit-credentials

# Paste the output of the first command into your config/credentials.yml file
```

In the editor which appears append admin email and password for the development environment admin portal.
It would look similar to below:

```yml
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: <auto-generated-key-base>

active_record_encryption:
  key_derivation_salt: <auto-generated-key-derivation-salt>
  deterministic_key: <auto-generated-key>
  primary_key: <auto-generated-primary-key>

development:
  mailer:
    email: adminuser@email.com
    password: tester123
```

Then save the file and exit the editor.

When deploying a production instance, you will also want to include a
`production:` section in the above yaml file, following the same format as the
`development:` section.

**_Note:_** `config/master.key` and `config/credentials.yml.enc` are generated or edited within the docker, they may have different file permissions to the other files in the repo. If you have an issue: `error checking context: no permission to read from '/home/<user>/<dir>/CTRL/config/master.key` then you may have to change ownership:

```shell
sudo chown <user>:<group> config/master.key config/credentials.yml.enc
```

#### Start up development environment

```shell
make up
```

This will:

- build containers,
- install Yarn dependencies,
- create the database,
- migrate the database,
- seed the database,
- and, start the rails, selenium, smtp and web servers.

After seeding, an Admin user is created with the following credentials:

```
email: adminuser@email.com
password: tester123
```

As well as a normal User with the following credentials:

```
email: testuser@email.com
password: tester123
```

To access the homepage and login, go to `localhost:3000`. When you login, you will be sent a one-time password (OTP) via email. An in-memory SMTP server runs at `localhost:1025`. View your OTP by visiting the SMTP server's web interface at `localhost:8025`.

To access the Active Admin interface and the survey builder, go to `localhost:3000/admin`.

If you want to try and register a new user, you can append with the following Participant ID: A1543458

##### Other Make commands

Each of the steps above has a separete `make` command (e.g. `make .docker`; see `makefile` for more details). These steps `touch` an empty file to signify that that step was successful and doesn't need to be re-run. Run `make clean` to break the cache and delete all these `.<step>` files.

Other commands are:

```shell
# Stop servers
make down

# Remove docker volume (persistent database data)
make rm-volume

# Run Ruby tests
make tests

# Open Rails REPL with application data loaded
make console
```

### <a id="gettingstartedstandard"></a> Getting Started - Standard

##### Make sure you have Ruby 2.5.3 by doing `ruby -v` from your console.

##### It is recommended to have Node v14.16.1 (you can check the node version by doing `node -v` from your console). Also do a `yarn -v` to check if you have yarn installed. If it isn't installed then do `npm install --global yarn`.

##### Install gems via bundler

```shell
bundle install
```

##### Create and build the database.

```shell
rails db:create
rails db:migrate
```

##### Install yarn dependencies

```shell
yarn install
```

##### Seed the database

```shell
rails db:reset
```

##### Start the server! `rails s`

### <a id="creatingadminaccount"></a> Creating an Admin account

To access the Active Admin interface and the survey builder, create an admin account by opening up the server console:

```shell
rails c
```

and create an `AdminUser`

```shell
AdminUser.create(email: 'youremail@gmail.com', password: 'yourpassword')
```

then you can access the admin interface by going to `localhost:3000/admin` and typing in your credentials. Make sure to checkout the Documentation page from the navigation bar.

## <a id="guides"></a> Guides

### <a id="strategiesfori18n"></a> Strategies for Multi-Language Support

Multi-language support (aka [internationalization](https://guides.rubyonrails.org/i18n.html)) has been implemented within the project.

To see the English locale, navigate to `config/locales/en.yml`

To add the Chinese locale for example, create another yml file `config/locales/ch.yml` and imitate the structure of `en.yml`.

For example,

For the `hello_world` line in the English locale (`en.yml`):

```yaml
en:
  hello_world: Hello World!
```

Should correspond to an equivalent translated line in the the Chinese locale (`ch.yml`):

```yaml
ch:
  hello_world: 你好世界
```

The Survey form builder does not currently support internationalization. However, this could be implmented by creating separate fields for each table that displays text.

For example, if we want to support Chinese questions, then we can add `question_chinese` and `description_chinese` columns to the `Question` table and modify the Vue components to show the Chinese columns for the Chinese version and show the english columns for the English version.

### <a id="2faintegration"></a> Two Factor Authentication integration

We recommend using [Devise-Two-Factor](https://github.com/tinfoil/devise-two-factor). Devise-Two-Factor is a minimalist extension to Devise which offers support for two-factor authentication, through the [TOTP](https://en.wikipedia.org/wiki/Time-based_One-Time_Password) scheme. It integrates easily with two-factor applications like [Google Authenticator](https://support.google.com/accounts/answer/1066447?hl=en) and [Authy](https://authy.com/).

Add Devise-Two-Factor to your Gemfile with:

```ruby
gem 'devise-two-factor'
```

Next, since Devise-Two-Factor encrypts its secrets before storing them in the database, you'll need to generate an encryption key, and store it in an environment variable of your choice. Set the encryption key in the model that uses Devise:

```ruby
  devise :two_factor_authenticatable,
         :otp_secret_encryption_key => ENV['YOUR_ENCRYPTION_KEY_HERE']

```

Finally, you can automate all of the required setup by simply running:

```ruby
rails generate devise_two_factor user ENVIRONMENT_VARIABLE
```

`ENVIRONMENT_VARIABLE` is the name of the variable you're storing your encryption key in.

Remember to apply the new migration.

```ruby
bundle exec rake db:migrate
```

It also adds the `:two_factor_authenticatable` directive to the user model, and sets up your encryption key. If present, it will remove `:database_authenticatable` from the model, as the two strategies are incompatible. Lastly, the generator will add a Warden config block to your Devise initializer, which enables the strategies required for two-factor authentication.

From the Application Controller:

```ruby
before_action :configure_permitted_parameters, if: :devise_controller?

...

protected

def configure_permitted_parameters
  devise_parameter_sanitizer.permit(:sign_in, keys: [:otp_attempt])
end
```

_After running the generator, verify that `:database_authenticatable` is not being loaded by your model. The generator will try to remove it, but if you have a non-standard Devise setup, this step may fail. Loading both `:database_authenticatable` and `:two_factor_authenticatable` in a model will allow users to bypass two-factor authenticatable due to the way Warden handles cascading strategies._

### <a id="passwordsecurityanduservalidation"></a> Password security and user validation

2FA should be sufficient for securing user sessions, but passwords should at least be 8 characters long. Special characters should not be a requirement if the user has 2FA setup during registration.

### <a id="integrationofcms"></a> Integration of a Content Management System

We recommend using [Refinery](https://github.com/refinery/refinerycms). Refinery CMS is in our view one of the best Ruby on Rails content management systems for many years now. Released as open-source in 2009, Refinery uses the ‘Rails way’ wherever possible but also allows the flexibility to design your website in your own way.

To integrate Refinery.

Open up your Gemfile and add the latest version (a later version than the one shown below may exist):

```ruby
gem 'refinerycms', '~> 3.0.0'
```

Refinery doesn't ship with authentication by default, but you will need to add it unless you want every visitor to be automatically logged in.

If you want to use the default authentication system:

```ruby
gem 'refinerycms-authentication-devise', '~> 1.0'
```

Now, to install the gems, run:

```shell
bundle install
```

#### Generating support files and migrations, and preparing the database.

Generating Refinery on top of an existing application is marginally more complicated than it was before, but it's still relatively straightforward:

```shell
rails generate refinery:cms --fresh-installation
```

This command does a few things:

- It creates `config/initializers/refinery/` and copies over all the required initializers from Refinery

- It copies all Refinery migrations to your apps migration folder and runs these migrations, and adds the seed data to your database

- It injects Refinery's mounting line into your `config/routes.rb` file

- It inserts `require refinery/formatting` and `require refinery/theme` lines in your apps application.css file

- After this, you should be all set. Don't forget to revisit the initializers in `config/initializers/refinery/` to customize your experience.

#### Mounting to a directory other than root

It is possible to mount Refinery to a subfolder. To do this, simply change the following setting in `config/initializers/refinery/core.rb`.

```ruby
config.mounted_path = "/subfolder"
```

After starting your rails server and navigating to `localhost:3000/subfolder`, you should see a dummy home page.

You can create the initial admin user by visiting `localhost:3000/subfolder/refinery`.

### <a id="resetenv"></a> Resetting your environment

```bash
# Stop all running containers mentioned in the docker-compose.yml file. Note
# that if services were removed from the docker-compose.yml file between running
# `docker-compose up` and `docker-compose down`, those services will not be
# stopped.
docker-compose down

# Remove CTRL docker volume
docker volume rm ctrl_db_data

# Remove, for example, `node_modules/`, `public/packs/`, `tmp/cache/`.
# ***WARNING***: the command below will remove any files that are not being tracked by git.
# use `git clean -xdfn` for a dry-run to see which files will be deleted
git clean -xdf
```

## <a id="testing"></a> Testing

We use [Capybara](https://github.com/teamcapybara/capybara) and [Rspec](https://rspec.info/) for our unit tests.

Before running the tests, you might want to run some or all of the commands
in the [resetting your environment](#resetenv) section. (If in doubt, run them all!)

Make sure you also follow the
[Getting Started - via Docker (recommended)](#gettingstarteddocker) section.
However, note that any step containing `--env-file=.env.dev`, should have it
replaced by `--env-file=.env.test`.

With that done, you can run the `cucumber` tests in docker using the following
command:

```shell
docker-compose --env-file=.env.test run web bundle exec rake cucumber
```

Similarly, to run the `rspec` tests:

```shell
docker-compose --env-file=.env.test run web bundle exec rspec
```

We also use playwright to test active admin. The `.github/workflows/pipeline.yml`
file is the source of truth for how to run those tests. But the commands are
copied here for your convenience:

```shell
docker-compose --env-file=.env.playwright run web yarn install
docker-compose --env-file=.env.playwright run web bundle exec rails db:create
docker-compose --env-file=.env.playwright run web bundle exec rails db:migrate
docker-compose --env-file=.env.playwright run web bundle exec rails db:reset
docker-compose --env-file=.env.playwright up -d

# Wait until the web server is ready
while ! curl -s http://localhost:3000 >/dev/null
do
  echo web server not ready, retrying in 5 seconds...
  sleep 5
done

docker-compose --env-file=.env.playwright run playwright npx playwright test --trace on
```

You can update the snapshots using `npx playwright test` too, by deleting the
existing snapshots before running the command.

### <a id="testingknownissues"></a> Known Issues

_For MacOS Catalina and Big Sur_

If you encounter this error while bundling:

```
An error occurred while installing libv8 (3.16.14.19), and Bundler
cannot continue.
Make sure that `gem install libv8 -v '3.16.14.19' --source
'https://rubygems.org/'` succeeds before bundling.
```

Update your brew installation.

```shell
brew install v8@3.15
bundle config build.libv8 --with-system-v8
bundle config build.therubyracer --with-v8-dir=$(brew --prefix v8@3.15)
bundle
```

[Source](https://stackoverflow.com/questions/27875073/an-error-occurred-while-installing-libv8-3-16-14-7-and-bundler-cannot-continu)

## <a id="deployment"></a> Deployment

### <a id="installingheroku"></a> Installing Heroku

Make sure you have installed the [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli)

Login with your Heroku credentials using `heroku login`.

Add the Heroku git remote using `heroku git:remote -a agha`.

### <a id="deployingtoheroku"></a> Deploying to Heroku

```shell
git add .
git commit -m [Your message](https://github.com/erlang/otp/wiki/writing-good-commit-messages)
git push heroku master
```

## <a id="environment-variables"></a> Environment Variables

- `CTRL_ADMIN_EMAIL` - This is the address from which emails are sent to study participants. It's also the address to which emails are sent when a study participant uses the "Contact Us" form.
- `OTP_ENABLED` - Whether or not login should be permitted without entering a valid OTP. Valid values are `true` and `false`. Defaults to `true`.
- `REDCAP_API_URL`
- `REDCAP_CONNECTION_ENABLED` - Whether data should be forwarded to REDCap. Valid values are `true` and `false`. Defaults to `false`.
- `REDCAP_TOKEN`
